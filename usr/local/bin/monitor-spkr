#!/bin/sh

# Part of tiny-radioCD project, originally designed & hand-crafted by macmpi
# check License at project home https://github.com/macmpi/tiny-radioCD


# Bluetooth devices mays connect/disconnect frequently
# Default referenced speaker may spontaneously
# connect after startup (or reconnect after failure)
# Lets find if reconnected bluetooth speaker is default one
# and relink mpd or disconnect accordingly


# inspired by:
# https://github.com/Arkq/bluez-alsa/wiki/Using-BlueALSA-as-default-ALSA-PCM#automation

# create a temporary named pipe to communicate with bluealsa-cli monitor
FIFO_PATH=$(mktemp -u)
mkfifo $FIFO_PATH
# attach it to unused file descriptor FIFO_FD
exec 4<>$FIFO_PATH
# unlink the named pipe
rm $FIFO_PATH

# make sure the pipeline is shut down if this script interrupted
trap "kill %1; exec 4>&-; exit 0" INT TERM

# start bluealsa-cli monitor in background
bluealsa-cli --quiet monitor >&4 &

while read LINE; do
	echo "$LINE" >> /tmp/trace
	if ! [ -f /tmp/.SW_SPKR ]; then
		MAC="$( echo "$LINE" | grep "PCMAdded" | grep -o "[[:xdigit:]_]\{18\}" | sed 's/_/:/g' | cut -c2- )"
		echo "$MAC" >> /tmp/trace
		if [ -n "$MAC" ]; then
			if ( grep -q "$MAC" /etc/alsa/conf.d/20-bluealsa.conf ) ;then
				echo "YES" >> /tmp/trace
				mpc -q toggle; mpc -q toggle
			else
				echo "NO" >> /tmp/trace
				bluetoothctl disconnect "$MAC" > /dev/null 2>&1
			fi
		fi
	fi
done <&4

