#!/bin/sh

# Part of tiny-radioCD project, originally designed & hand-crafted by macmpi
# check License at project home https://github.com/macmpi/tiny-radioCD


#Expects file containing BT MAC address passed as input
MAC="$(cat $1 | grep -o "[[:xdigit:]:]\{17\}" | tr a-z A-Z )"

[ -z "$MAC" ] && { logger -s -t set-speaker "Failed; wrong MAC address"; exit 1;}

sed -i "s/^defaults.bluealsa.device.*/defaults.bluealsa.device \"$MAC\"/" /etc/alsa/conf.d/20-bluealsa.conf

logger -s -t set-speaker "Default speaker changed to $MAC"

###############################
# If not in sys mode, update file within apkovl archive
# as we just replace MAC address, and do not modify file length
# we can do a sed within tar file
# (we avoid lbu commit -d as it does not play nice with inotifyd)
 
if ! grep -q "root=" /proc/cmdline ;then
	. /etc/lbu/lbu.conf
	DEV="$( df | grep "/media/$LBU_MEDIA" | awk '{ print $1 }' )"
	grep -q "/media/$LBU_MEDIA.*[[:space:]]ro[[:space:],]" /proc/mounts; RO=$?
	[ "$RO" -eq "0" ] && mount -o remount,rw $DEV /media/$LBU_MEDIA
	zcat /media/$LBU_MEDIA/tiny-radiocd.apkovl.tar.gz | \
	sed "s/^defaults.bluealsa.device.*/defaults.bluealsa.device \"$MAC\"/" \
	| gzip > /media/$LBU_MEDIA/temp.tgz
	mv /media/$LBU_MEDIA/temp.tgz /media/$LBU_MEDIA/tiny-radiocd.apkovl.tar.gz
	sync
	[ "$RO" -eq "0" ] && mount -o remount,ro $DEV /media/$LBU_MEDIA
fi


