#!/bin/sh

# Part of tiny-radioCD project, originally designed & hand-crafted by macmpi
# check License at project home https://github.com/macmpi/tiny-radioCD


# Switch Bluetooth speakers for MPD across all paired speakers

SWITCHED=false
curr_spkr="$( grep "defaults.bluealsa.device " /etc/alsa/conf.d/20-bluealsa.conf | \
grep -o "[[:xdigit:]:]\{17\}" 2> /dev/null )"

PAIRED="$( bluetoothctl devices Paired )"
while read -r LINE; do
	MAC="$( echo "$LINE" | grep -o "[[:xdigit:]:]\{17\}" )"
	[ -z "$MAC" ] && break
	[ "$MAC" = "$curr_spkr" ] && continue

	if bluetoothctl info "$MAC" | grep -q "UUID: Audio Sink"; then
		touch /tmp/.SW_SPKR		# set flag so monitor-spkr ignores connections
		if bluetoothctl connect "$MAC" > /dev/null 2>&1; then
			SWITCHED=true
			logger -st ${0##*/} "Connected to ${LINE/Device $MAC /}"
			set-speaker "$MAC"
			bluetoothctl disconnect "$curr_spkr" > /dev/null 2>&1
			service mpd restart > /dev/null 2>&1
			while ! mpc -q > /dev/null 2>&1; do sleep 0.3; done	# let MPD settle
			break
		else
			logger -st ${0##*/} "Failed to connect to ${LINE/Device $MAC /}"
		fi
	fi
done <<EOF
$PAIRED
EOF

rm /tmp/.SW_SPKR > /dev/null 2>&1	# let monitor-spkr operate normaly
$SWITCHED

