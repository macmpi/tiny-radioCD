#!/bin/sh

# Part of tiny-radioCD project, originally designed & hand-crafted by macmpi
# check License at project home https://github.com/macmpi/tiny-radioCD


# Switch Bluetooth speakers for MPD across all paired speakers

curr_spkr="$( grep "defaults.bluealsa.device " /etc/alsa/conf.d/20-bluealsa.conf | \
grep -o "[[:xdigit:]:]\{17\}" 2> /dev/null )"

PAIRED="$( bluetoothctl paired-devices )"
while read LINE; do
	MAC="$( echo "$LINE" | grep -o "[[:xdigit:]:]\{17\}" )"
	[ -z "$MAC" ] && break
	[ "$MAC" = "$curr_spkr" ] && continue

	AUDIO=$(bluetoothctl info "$MAC" | grep -c "UUID: Audio Sink")
	if [ "$AUDIO" -eq "1" ]; then
		touch /tmp/.SW_SPKR		# set flag so monitor-spkr ignores connections
		if bluetoothctl connect "$MAC" > /dev/null 2>&1; then
			printf "$MAC" | set-speaker
			bluetoothctl disconnect "$curr_spkr" > /dev/null 2>&1
			service mpd restart > /dev/null 2>&1
			break
		fi
	fi
done <<EOF
$PAIRED
EOF

rm /tmp/.SW_SPKR > /dev/null 2>&1	# let monitor-spkr operate normaly

